<!DOCTYPE html>
<html>

<head>
    <title>URSI LLM Convo Bot Experiment</title>
    <!-- loading jsPsych -->
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />

    <!-- loading jsPsych plug-ins -->
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe@0.1"></script> <!-- for data pipe -->
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script> <!-- condition assignment using data pipe -->
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="../dist/index.browser.js"></script> <!--- local chat plug-in access-->
    <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.3"></script>
    <link rel="stylesheet" href="https://unpkg.com/@jspsych/plugin-survey@1.0.1/css/survey.css" />
    <script src="https://unpkg.com/@jspsych/plugin-survey@1.0.1"></script>

    <!-- loading react-->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script> <!-- -->
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script> <!--  -->

    <!-- surveyJS slider plug-in upload -->
    <link href="https://unpkg.com/browse/nouislider@15.8.0/package.json" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.js"></script>

    <!-- uploading survey question jsons -->
    <script src="pre_convo_survey_json.js"></script> <!-- survey -->
    <script src="post_convo_survey_republican.js"></script> <!-- survey -->
    <script src="post_convo_survey_democrat.js"></script> <!-- survey -->
    <script src="post_convo_survey_euthanasia.js"></script> <!-- survey -->
    <script src="post_convo_survey_healthcare.js"></script> <!-- survey -->
    <script src="post_convo_survey_vaccines.js"></script> <!-- survey -->
    <script src="post_convo_survey_bombing.js"></script> <!-- survey -->
    <script src="post_convo_survey_gender.js"></script> <!-- survey -->
    <script src="post_convo_survey_same_sex.js"></script> <!-- survey -->
    <script src="post_convo_survey_criminal.js"></script> <!-- survey -->

    <!-- loading css -->
    <link href="styles.css" rel="stylesheet" type="text/css"> <!-- local-ui access -->


    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cantarell:ital,wght@0,400;0,700;1,400;1,700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Exo:ital,wght@0,100..900;1,100..900&display=swap');

        /* slider format */
        .slider {
            font-size: 20px;
            font-weight: bold;
            color: black;
        }
    </style>
</head>

<body>
    <script>

        //Initialize jsPsych, redirect to prolific page upon completing experiment
        var jsPsych = initJsPsych({
            on_finish: function () {
                jsPsych.data.displayData();
                jsPsych.data.get().localSave("csv", "llm_trial.csv"); //save chatbot conversation to local for when testing bot on computer.
                //window.location = "https://app.prolific.com/submissions/complete?cc=CVWBBA5S";
            },
        });

        // capture info from Prolific
        var prolific_subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID');
        var study_id = jsPsych.data.getURLVariable('STUDY_ID');
        var session_id = jsPsych.data.getURLVariable('SESSION_ID');

        //add captured info into jsPsych data
        jsPsych.data.addProperties({
            prolific_subject_id: prolific_subject_id,
            study_id: study_id,
            session_id: session_id
        });

        // PRIOR TO LAUNCHING PILOT ADD JSPSYCH PIPE IN THE ASYNC FUNCTION AND CHANGE ALL JSON ISREQUIREDS TO TRUE 

        // disable right-click to prevent accesing browser console (to prevent user from seeing chat-bot prompt)
        /*document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        });
*/

        // disable keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            if (e.key === 'F12' ||
                (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                (e.ctrlKey && e.shiftKey && e.key === 'J') ||
                (e.ctrlKey && e.key === 'U') ||
                (e.ctrlKey && e.shiftKey && e.key === 'C')) {
                e.preventDefault();
            }
        });

        // disable text selection
        document.addEventListener('selectstart', function (e) {
            e.preventDefault();
        });


        // create timelines for conditions. the contents of each timeline are at the bottom of this doc
        var counter_timeline = [];
        var question_timeline = [];
        var viewpoint_timeline = [];
        var control_timeline = [];
        var combination_timeline = [];

        // sequential condition assignment using data pipe. pushing a condition timeline into the timeline variable
        var timeline = [];
        async function createExperiment() {
            const condition = 2;
            if (condition == 0) { timeline = counter_timeline; }
            if (condition == 1) { timeline = question_timeline; }
            if (condition == 2) { timeline = viewpoint_timeline; }
            if (condition == 3) { timeline = control_timeline; }
            if (condition ==4) { timeline = combination_timeline; }
            jsPsych.run([...timeline]);
        }

        // setting subject_id and filename for confidential data analysis 
        const subject_id = jsPsych.randomization.randomID(10);
        const filename = `${subject_id}.csv`;

        /*  welcome message  */
        var welcome = {
            data: {
                phase: "welcome-message",
            },
            type: jsPsychHtmlKeyboardResponse,
            stimulus: "Welcome to the experiment! Press any key to begin.",
        };

        /* brief instructions for people in bot convo timelines */
        var preliminary_convo_instructions = {
            data: {
                phase: "convo-instructions",
            },
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <p> In this experiment, you will have a short conversation with an AI chatbot about a disputed topic in America. </p>
                <p> Before you chat with the bot, there is a survey for you to fill out. </p>
                <div style='width: 700px;'>
                </div>
                <p> Press any key to proceed to the questionnaire. </p>
                `,
            post_trial_gap: 500,
        };

        /* brief instructions for people in control timeline */
        var preliminary_control_instructions = {
            data: {
                phase: "control-instructions",
            },
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <p> In this experiment, you will be asked to freely reflect on a disputed topic in America. </p>
                <p> Before this reflection, there is a survey for you to fill out. </p>
                <div style='width: 700px;'>
                </div>
                <p>Press any key to proceed to the questionnaire. </p>
                `,
            post_trial_gap: 500,
        };

        /* pre-chat survey with different topic options implemented via SurveyJS */

        /* create slider constant for pre-convo survey */
        const initializePreSlider = (survey) => {
            //search for every question in the surveyJs with -placeholder in the name, and add a variable for each slider. 
            //because we put the slider and the question for the text as two seperate question, and named the question text with 'placeholder'
            survey.onAfterRenderQuestion.add(function (survey, options) {
                const name = options.question.name;

                // if (sliderQuestions.has(name)) {
                if (name.includes("-placeholder")) {

                    var slider = document.getElementById(name);
                    noUiSlider.create(slider, {
                        start: [50],
                        range: {
                            min: 0,
                            max: 100,
                        },
                        step: 1,
                        tooltips: true,
                    });
                    slider.noUiSlider.on("set", function () {
                        options.question.value = slider.noUiSlider.get();
                    });
                }
            });
        };
        
        let surveyResponses = [];

        function extractRelevantRow(responses) {
            let relevantRow = [];

            // Function to find a row with specific column values
            function findRowWithValue(values) {
                for (let row in responses) {
                    let columnValue = responses[row];
                    if (columnValue === values) {
                        return  [{ row }];
                    }
                }
                return null;
            }

            // Loop to check i or 8-i)
            for (let i = 1; i <= 4; i++) {
                // Check for i
                relevantRow = findRowWithValue(i);
                if (relevantRow !== null) {
                    return relevantRow;
            }
                // Check for 8 - i
                relevantRow = findRowWithValue(8 - i);
                if (relevantRow !== null) {
                    return relevantRow;
                }}
            }

         //   return relevantRow;
       // }

        
// check i and 8-i and then loop 
        //creating variable for saving user response to use for conditional survey structure 
        //(so user only answer question for the topic they selected)
        let rowAsString;
        let topicChoice;

        /* pushing survey in timeline with both slider and non-slider questions */
        const pre_convo_survey_trial = {
            type: jsPsychSurvey,
            survey_json: pre_convo_survey_json,
            survey_function: initializePreSlider,
            data: {
                phase: "pre-convo-survey",
            },
            on_finish: (data) => {
                /*
                // check console for debugging
                console.log('Pre-convo survey data:', data);
                */

                // for post-survey party-specific questions (so republicans only answer question republicans, vice versa for democrat)
                data.response["political-affiliation"];

                // get topic choice to feed into chat later
                let topicChoice = data.response['topicChoice'];
                console.log(topicChoice);

                // extract issue-specific polarization survey responses from data object
                // need to iterate through the possible questions
                // first, create a constant that lists the possible questions...
                const possibleQuestions = [
                    "euthanasia-polarization",
                    "gender-polarization",
                    "healthcare-polarization",
                    "bombing-polarization",
                    "vaccines-polarization",
                    "criminal-polarization",
                    "same-sex-polarization"
                ];

                // ...then extract and process each row's responses
                possibleQuestions.forEach(row => {
                    let surveyResponses = data.response[row];
                    if (surveyResponses) {
                        //console.log('Survey responses', surveyResponses);  //check console for debugging

                        // extract relevant rows
                        let relevantRow = extractRelevantRow(surveyResponses);
                        //console.log('Relevant rows', relevantRow);  //check console for debugging

                        // convert relevant row into a string so we can feed it into chat later
                        relevantRow.forEach(rowObj => {
                            data.rowAsString = rowObj;
                            console.log(data.rowAsString);
                        });

                    } else {
                        console.log('No responses');  // debugging, won't ever get here because SurveyJS question all set to required
                    };
                });
            }
        };

        /* break between pre-intervention survey and bot conversation */
        var pre_bot_instructions_break = {
            data: {
                phase: "pre-bot-break",
            },
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
        <p> You have now completed the pre-conversation questionnaire. </p>
        <p> Feel free to take a short break if needed. </p>
        <p> Press any key to proceed. </p>
      `,
            post_trial_gap: 1000,
        };

        var pre_convo_instructions = {
            data: {
                phase: "pre-convo-instructions",
            },
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
        <p> You will be conversing with a chatbot designed for conversations about disputed topics. </p>
        <p> Be as truthful to your beliefs as possible during the conversation, and try your best to give full responses to the bot. </p>
        <p> The conversation will end after you and the bot exchange seven messages. There is no right or wrong answer, no good or bad response to the bot. </p>
        <p> Press any key when you are ready to begin the conversation. </p>
      `,
            post_trial_gap: 1000,
        };

        /* break inbetween pre-intervention survey and free reflection*/
        var pre_control_break = {
            data: {
                phase: "pre-control-break",
            },
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
        <p> Good work! You have now completed the pre-reflection questionnaire. </p>
        <p> Feel free to take a short break if needed. </p> 
        <p> Press any key when you are ready to proceed to the free reflection. </p>
      `,
            post_trial_gap: 1000,
        };


        /* define post-chatinstructions, add post-chat survey */

        /* post-convo message and break before questionnaire */
        let polaffiliation = "UNIDENTIFIED";

        var post_convo_break = {
            data: {
                phase: "post-convo-break",
            },
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
        <p> Great job! You have completed the conversation. Feel free to take a short break. <p>
        <p> Before we send you back to Prolific, please complete a post-conversation questionnaire. <p>
        <p> Press any key to proceed to the questionnaire.  <p>
      `,
            post_trial_gap: 1000,
        };

        var post_control_break = {
            data: {
                phase: "post-control-break",
            },
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
        <p> You have completed the free reflection! Feel free to take another short break. <p>
        <p> Before we send you back to Prolific, please complete a post-reflection questionnaire. <p>
        <p> Press any key to proceed to the questionnaire.  <p>
      `,
            post_trial_gap: 1000,
        };

        const initializePostSlider = (survey) => {
            survey.onAfterRenderQuestion.add(function (survey, options) {
                const name = options.question.name;

                if (name.includes("-placeholder")) {

                    var slider = document.getElementById(name);
                    noUiSlider.create(slider, {
                        start: [50],
                        range: {
                            min: 0,
                            max: 100,
                        },
                        step: 1,
                        tooltips: true,
                    });
                    slider.noUiSlider.on("set", function () {
                        options.question.value = slider.noUiSlider.get();
                    });
                }
            });
        };

        /* !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!----------INTERVENTIONS (BOT CONDITIONS) ---------- !!!!!!!!!!!!!!!!!!!!!!!!!!!!*/

        // Declaring the prompts for three chat bot conditions: counter bot (only argues), question bot (only ask question), viewpoint bot (provide alternative viewpoint)
        
        //counter bot prompts
        combination_prompts = [
            //set role to 'chatbot' for specific message to be sent via the bot
            {
                message: "Welcome to the chatroom!",
                role: "system-prompt",
                message_trigger: 0
            },
            {
                message: () => { 
                    // function to insert depolarization survey response statement into the bot's conversation starter
                    const lowercaseFirstLetter = (str) => { //function to convert the first letter of the string into lowercase so it can be seamlessly inserted into the bot's question
                        if (!str) return str;  // return the string if it's empty or not a string
                        return str.charAt(0).toLowerCase() + str.slice(1);
                    };

                    const bot_row = jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0]
                        .rowAsString["row"]; // extracting the depolarization statement again because it didn't work if i tried to use the string from earlier
                    const bot_row_formatted = lowercaseFirstLetter(bot_row); // use lowercase function
                    const topicChoiceAsString = jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0] // get topic choice
                        .response["topicChoice"];
                    return `Hey there! I'm here to chat about ${topicChoiceAsString}, a disputed topic. To get the conversation started, could you explain your view on whether ${bot_row_formatted}?`;
                },
                role: "chatbot-message",
                message_trigger: 0
            },
            /*{
                prompt: `
                Role: You are a researcher on social policies having a conversation with a student discussing controversial political topics on same-sex marriage, gender-equality, U.S. government role in healthcare, criminal justice, vaccine mandates, the Hiroshima Nagasaki atomic bombing, and human euthanasia.

                Goal: Your goal is to widen the user's perspective on the topic. Make them more open-minded.

                Strategy: Identify the user's main believes and either 1) provide alternative perspective or 2) formulate counterarguments against the user's belief. You are playing the devil's advocate, arguing against the user, providing widely diverse perspectives. Provide short counterarguments against the main point of whatever the user says. Provide a new perspective each time you argue. Never repeat the same arguments. 
                If the user has factually incorrect information correct them and offer factually correct information.
                If the user seem very extreme in their stance, ask if there is a reason or experience that made them think the way they do.
                When it helps, provide the perspective of people with different experiences.
                If the user refuses to change stance, leading to you repeating the same point multiple times, give a historically accurate anecdote that challenge's the user belief.
            
                Tone of voice: Sound friendly. Use colloqual and conversational language. Keep your response short to 2-5 sentences. At the end of each counter-argument, ask what the user thinks.`,
                role: "chatbot-prompt",
                message_trigger: 5,
            }*/
            //message_trigger run the prompt after 5 message is sent by the user, we repeated the same prompt again after 5 message because when we were running it (as if the prompt 'faded out'), the bot stopped arguing frequently after a few round of convo. Future editions of GPT API might not have same issue.
        ]
        
        //continue to next portion button will show up after 7 message exchanges
        continue_button = {
            message_trigger: 7,
            message: "You have completed your rounds of seven messages! Click continue to proceed with the experiment.",
        }

        
        const combination_trial = {
            type: jsPsychChat,
            ai_prompt: `Concisely summarize the user's stance. From the user's stance, determine whether to widen the user's perspective, it would be better to: 
      1) ask the user about their experience and why they think the way they do, 
      2) correct the user for factual information inaccuracy, provide new factual information that reshapes the user stance or
      3) share the perspective of a someone with a different societal position, political stance, experience that differed from the user's. Make sure the perspective differs from the user's.
        Change up your way of widening the user's perspective each time.
        Execute the strategy that you chose as best. If you ask about the user experience more than once, share a new perspective with factual information you have not brought up before. Do not greet the user, do not say certainly.`,
            continue_button: continue_button,
            chat_field_placeholder: "Share your perspective...",
            //prompt_chain: prompt_chain, //previousl fed in chain prompting here.
            additional_prompts: combination_prompts,
        };
        jsPsych.run([combination_trial]);


        /*Role: You are a researcher on social policies having a conversation with a student discussing controversial political topics on same-sex marriage, gender-equality, U.S. government role in healthcare, criminal justice, vaccine mandates, the Hiroshima Nagasaki atomic bombing, and human euthanasia.

                Goal: Your goal is to widen the user's perspective on the topic. Make them more open-minded.

                Strategy: Identify the user's main believes and either 1) provide alternative perspective or 2) formulate logic based counterarguments against the user's belief. You are playing the devil's advocate, arguing against the user, providing widely diverse perspectives. Provide short counterarguments against the main point of whatever the user says. Provide a new perspective each time you argue. Never repeat the same arguments. 
                If the user has factually incorrect information correct them and offer factually correct information.
                If the user seem very extreme in their stance, ask if there is a reason or experience that made them think the way they do.
                When it helps, provide the perspective of people with different experiences.
                If the user refuses to change stance, leading to you repeating the same point multiple times, give a historically accurate anecdote that challenge's the user belief.
            
                Tone of voice: Sound friendly. Use colloqual and conversational language. Keep your response short to 2-5 sentences. At the end of each counter-argument, ask what the user thinks.*/


        counter_prompts = [
            //set role to 'chatbot' for specific message to be sent via the bot
            {
                message: "Welcome to the chatroom!",
                role: "system-prompt",
                message_trigger: 0
            },
            {
                message: () => { 
                    // function to insert depolarization survey response statement into the bot's conversation starter
                    const lowercaseFirstLetter = (str) => { //function to convert the first letter of the string into lowercase so it can be seamlessly inserted into the bot's question
                        if (!str) return str;  // return the string if it's empty or not a string
                        return str.charAt(0).toLowerCase() + str.slice(1);
                    };

                    const bot_row = jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0]
                        .rowAsString["row"]; // extracting the depolarization statement again because it didn't work if i tried to use the string from earlier
                    const bot_row_formatted = lowercaseFirstLetter(bot_row); // use lowercase function
                    const topicChoiceAsString = jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0] // get topic choice
                        .response["topicChoice"];
                    return `Hey there! I'm here to chat about ${topicChoiceAsString}, a disputed topic. To get the conversation started, could you explain your view on whether ${bot_row_formatted}?`;
                },
                role: "chatbot-message",
                message_trigger: 0
            },
            
            {
                prompt: `Role: Your role is to be a policy education expert with whom people can discuss their beliefs about contentious topics. 
                Style: You should be conversational but use technically precise language. Be concise. You should match your response length to the user's input length.
                Task: You should always respond to the other person's argument with a counterargument with specific examples. You should never dive into asking the user how they would implement their views. You should always concisely present a specific argument that counters the user's perspective. At the end of your response, you should always ask the user what they think. You should always ensure that your message includes a counterargument; and you should never simply agree with the user.`,
                role: "chatbot-prompt",
                message_trigger: 5,
            }
            //message_trigger run the prompt after 5 message is sent by the user, we repeated the same prompt again after 5 message because when we were running it (as if the prompt 'faded out'), the bot stopped arguing frequently after a few round of convo. Future editions of GPT API might not have same issue.
        ]
        
        //continue to next portion button will show up after 7 message exchanges
        continue_button = {
            message_trigger: 7,
            message: "You have completed your rounds of seven messages! Click continue to proceed with the experiment.",
        }

        //PAST PROMPTS
        //"Add a short and specific counter-argument for the inputted perspective. Do not agree. Do not provide a greeting."
        //"Provide a short and specific example or reason why the inputted perspective is wrong. Always argue against the input. Do not agree with the user.", "Match the input to the user's response length", "Append a question to the end of the input asking what the user thinks about the inputted stance. Do not remove the input."
        
        //Experimenting with prompt chaining, new html started for experimenting with this.
        /*prompt_chain = {
            message_trigger: 0,
            prompts: ["Identify the user's main point.", "Provide a specific example or reason why the user's perspective is wrong. Hold the opposite stance from the user. Match the input to the user's response length."],
        }*/

        // putting prompt into counter bot conversation trial (a trial is where the actual convo happens with all the UI implemented for the plug-in)
        const counter_trial = {
            type: jsPsychChat,
            ai_prompt: `Role: Your role is to be a conversational chatbot with whom people can discuss their beliefs about contentious topics. 
            Style: You should be conversational and use colloquial language. You should match your response length to the user's input length.
            Task: You should always respond to the other person's argument with a counterargument. You should never dive into asking the user how they would implement their views. You should always concisely present a specific argument that counters the user's perspective. At the end of your response, you should always ask the user what they think. You should always ensure that your message includes a counterargument; and you should never simply agree with the user.`,
            continue_button: continue_button,
            chat_field_placeholder: "Share your perspective...",
            //prompt_chain: prompt_chain, //previousl fed in chain prompting here.
            additional_prompts: counter_prompts,
        };
        jsPsych.run([counter_trial]);


        //creating prompt for question bot condition
        question_prompts = [
            {
                message: "Welcome to the chatroom!",
                role: "system-prompt",
                message_trigger: 0
            },

            {
                message: () => { 
                    //function to insert depolarization survey response statement into the bot's conversation starter
                    const lowercaseFirstLetter = (str) => {
                        if (!str) return str;  //return the string if it's empty or not a string
                        return str.charAt(0).toLowerCase() + str.slice(1);
                    };

                    const bot_row = jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0]
                        .rowAsString["row"]; //get survey response
                    const bot_row_formatted = lowercaseFirstLetter(bot_row);
                    const topicChoiceAsString = jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0] //get topic choice
                        .response["topicChoice"];
                    return `Hey there! I'm here to chat about ${topicChoiceAsString}, a disputed topic. I'm not here to judge your beliefs; I'm just here to help you explore your views. To get the conversation started, could you explain your view on whether ${bot_row_formatted}?`;
                },
                role: "chatbot-message",
                message_trigger: 0
            },
            {
                prompt: `Role: Your role is to be a conversational chatbot with whom people can discuss their beliefs about contentious topics.
                Style: You should be conversational and use colloquial language. You should match your response length to the user's input length.
                Task: You should always ask a question about the user's stance. You should always ask why the user thinks what they think or ask if there were any experiences that led to their views.`,
                role: "chatbot-prompt",
                message_trigger: 5,
            }
        ]
        const question_trial = {
            type: jsPsychChat,
            ai_prompt: `Role: Your role is to be a conversational chatbot with whom people can discuss their beliefs about contentious topics.
            Style: You should be conversational and use colloquial language. You should match your response length to the user's input length.
            Task: You should always ask a question about the user's stance. You should always ask why the user thinks what they think or ask if there were any experiences that led to their views.`,
            continue_button: continue_button,
            chat_field_placeholder: "Share your perspective...",
            additional_prompts: question_prompts,
        };
        jsPsych.run([question_trial]);

        //creating prompts for viewpoint bot condition
        viewpoint_prompts = [
            {
                message: "Welcome to the chatroom!",
                role: "system-prompt",
                message_trigger: 0
            },

            //timer trigger in ms
            //"chatbot" = chatbot will say the thing typed in the prompt
            {
                message: () => { //put this as message because it was reading errors if i didn't 
                    // function is to insert depolarization string into the bot's prompt 
                    const lowercaseFirstLetter = (str) => { //function to convert the first letter of the string into lowercase so it can be seamlessly inserted into the bot's question
                        if (!str) return str;  // return the string if it's empty or not a string
                        return str.charAt(0).toLowerCase() + str.slice(1);
                    };


                    const bot_row = jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0]
                        .rowAsString["row"]; // extracting the depolarization statement again because it didn't work if i tried to use the string from earlier
                    const bot_row_formatted = lowercaseFirstLetter(bot_row); // use lowercase function
                    const topicChoiceAsString = jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0] // get topic choice
                        .response["topicChoice"];
                    return `Hey there! I'm here to chat about ${topicChoiceAsString}, a disputed topic. To get the conversation started, could you explain your view on whether ${bot_row_formatted}?`;
                },
                role: "chatbot-message",
                message_trigger: 0
            },
            {
                //prompt: "Always explain in detail the experiences of people with opposite views from the user without repeating the user's input. Provide the alternative viewpoints of people with different jobs, positions in society, beliefs, etc. Give different perspectives each time. Ask what the user thinks about those peoples' stances. Acknowledge the user's perpsective. Respond in 1 paragraph.",
                prompt: `Role: Your role is to be a policy education expert with whom people can discuss their beliefs about contentious topics. 
                Style: You should be conversational but use technically precise language. Be concise. You should match your response length to the user's input length.
                Task: You should always identify a specific group of people who may have differing opinions from the user. You should always talk about, in detail, their experiences and why they may disagree with the user's beliefs. You should provide these alternative perspectives held by people with different jobs, positions in society, beliefs, etc. You should give uniquely different perspectives in each message. You should always end your response with a question that asks the user what they think about those peoples' stances.`,
                role: "chatbot-prompt",
                message_trigger: 5,
            }
        ]
        const viewpoint_trial = {
            type: jsPsychChat,
            //ai_prompt: "Always explain in detail the experiences of people with opposite views from the user without repeating the user's input. Provide the alternative viewpoints of people with different jobs, positions in society, beliefs, etc. Give different perspectives each time. Ask what the user thinks about those peoples' stances. Acknowledge the user's perpsective. Respond in 1 paragraph.",
            ai_prompt: `Role: Your role is to be a policy education expert with whom people can discuss their beliefs about contentious topics. 
                Style: You should be conversational but use technically precise language. Be concise. You should match your response length to the user's input length.
                Task: You should always identify a specific group of people who may have differing opinions from the user. You should always talk about, in detail, their experiences and why they may disagree with the user's beliefs. You should provide these alternative perspectives held by people with different jobs, positions in society, beliefs, etc. You should give uniquely different perspectives in each message. You should always end your response with a question that asks the user what they think about those peoples' stances.`,
            chat_field_placeholder: "Share your perspective...",
            additional_prompts: viewpoint_prompts,
        };
        jsPsych.run([viewpoint_trial]);


        //creating text box for control condition
        var control_intervention = {
            type: jsPsychSurvey,
            data: {
                phase: "control-intervention",
            },
            survey_json: () => {
                const row = jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0]
                    .rowAsString["row"]

                var control_intervention_json = {
                    elements: [{
                        type: "comment",
                        name: "control-free-response",
                        title: `Please freely reflect in the space below on the following statement: "${row}"`,
                        isRequired: true,
                    }]
                }
                return control_intervention_json
            },
            survey_function: initializePostSlider,
        }

        /* ---------- PARTY SPECIFIC POST CHAT SURVEYS ---------- */
        //this is where the survey response from the pre-convo survey is for, to change the survey to be specific to the user
        //post survey placed in main experiment html, and not a seperate json, because we needed to insert strings from the prior extracted data

        var republican_survey = {
            data: {
                phase: "post-convo-republican-survey",
            },
            timeline: [
                {
                    type: jsPsychSurvey,
                    survey_json: post_convo_survey_republican
                }
            ],
            conditional_function: () => {
                return (
                    jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0]
                        .response["political-affiliation"] == "Republican"
                );
            },
        };

        var democrat_survey = {
            data: {
                phase: "post-convo-democrat-survey",
            },
            timeline: [
                {
                    type: jsPsychSurvey,
                    survey_json: post_convo_survey_democrat,
                }
            ],
            conditional_function: () => {
                return (
                    jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0]
                        .response["political-affiliation"] == "Democrat"
                );
            },
        };

        var neutral_survey = {
            data: {
                phase: "pre-convo-independent-survey",
            },
            timeline: [
                {
                    type: jsPsychSurvey,
                    survey_json: post_convo_survey_republican,
                },
                {
                    type: jsPsychSurvey,
                    survey_json: post_convo_survey_democrat,

                }
            ],
            conditional_function: () => {
                return (
                    jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0]
                        .response["political-affiliation"] == "Independent"
                );
            },
        };


        var other_survey = {
            data: {
                phase: "post-convo-no-political-affiliation-survey",
            },
            timeline: [
                {
                    type: jsPsychSurvey,
                    survey_json: post_convo_survey_republican,
                },
                {
                    type: jsPsychSurvey,
                    survey_json: post_convo_survey_democrat,
                }
            ],
            conditional_function: () => {
                // Assuming there's a different or no specific filter condition for "other" affiliations
                return !["Republican", "Democrat", "Independent"].includes(
                    jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0]
                        .response["political-affiliation"]
                );
            },
        };

        //TOPIC SPECIFIC POST CHAT SURVEY

        var euthanasia_post_survey = {
            data: {
                phase: "post-convo-euthanasia-survey",
            },
            timeline: [
                {
                    type: jsPsychSurvey,
                    survey_json: post_convo_survey_euthanasia,
                    survey_function: initializePostSlider,
                }
            ],
            conditional_function: () => {
                return (
                    jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0]
                        .response["topicChoice"] == "human euthanasia in the U.S."
                );
            },
        };

        var gender_post_survey = {
            data: {
                phase: "post-convo-gender-survey",
            },
            timeline: [
                {
                    type: jsPsychSurvey,
                    survey_json: post_convo_survey_gender,
                    survey_function: initializePostSlider,
                }
            ],
            conditional_function: () => {
                return (
                    jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0]
                        .response["topicChoice"] == "gender equality in the U.S."
                );
            },
        };


        var healthcare_post_survey = {
            data: {
                phase: "post-convo-healthcare-survey",
            },
            timeline: [
                {
                    type: jsPsychSurvey,
                    survey_json: post_convo_survey_healthcare,
                    survey_function: initializePostSlider,
                }
            ],
            conditional_function: () => {
                return (
                    jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0]
                        .response["topicChoice"] == "the role of the U.S. government in healthcare"
                );
            },
        };

        var bombings_post_survey = {
            data: {
                phase: "post-convo-bombings-survey",
            },
            timeline: [
                {
                    type: jsPsychSurvey,
                    survey_json: post_convo_survey_bombing,
                    survey_function: initializePostSlider,
                }
            ],
            conditional_function: () => {
                return (
                    jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0]
                        .response["topicChoice"] == "the atomic bombings of Hiroshima and Nagasaki"
                );
            },
        };

        var vaccines_post_survey = {
            data: {
                phase: "post-convo-vaccines-survey",
            },
            timeline: [
                {
                    type: jsPsychSurvey,
                    survey_json: post_convo_survey_vaccines,
                    survey_function: initializePostSlider,
                },
            ],
            conditional_function: () => {
                return (
                    jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0]
                        .response["topicChoice"] == "mandating vaccines in the U.S."
                );
            },
        };


        var criminal_post_survey = {
            data: {
                phase: "post-convo-criminal-survey",
            },
            timeline: [
                {
                    type: jsPsychSurvey,
                    survey_json: post_convo_survey_criminal,
                    survey_function: initializePostSlider,
                }
            ],
            conditional_function: () => {
                return (
                    jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0]
                        .response["topicChoice"] == "the criminal justice system in the U.S."
                );
            },
        };

        var same_sex_post_survey = {
            data: {
                phase: "post-convo-same-sex-survey",
            },
            timeline: [
                {
                    type: jsPsychSurvey,
                    survey_json: post_convo_survey_same_sex,
                    survey_function: initializePostSlider,
                }
            ],
            conditional_function: () => {
                return (
                    jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0]
                        .response["topicChoice"] == "same-sex marriage in the U.S."
                );
            },
        };

        var last_questions = {
            data: {
                phase: "post-convo-last-questions-survey",
            },
            type: jsPsychSurvey,
            survey_json: () => {
                const topicChoiceAsString = jsPsych.data.get().filter({ phase: "pre-convo-survey" }).values()[0] // get topic choice
                    .response["topicChoice"];
                var experimental_group_last_questions = {
                    elements: [
                        {
                            type: "comment",
                            name: "free-response",
                            title:
                                `After your conversation with the chat bot, do you feel more willing to have a conversation with others about ${topicChoiceAsString}? Please freely reflect in the space below.`,
                            isRequired: true,
                        },
                        {
                            type: "radiogroup",
                            name: "willing-to-converse-likert-post",
                            title:
                                `Rate this conversation's effect on your willingness to converse about ${topicChoiceAsString} with others. Rate on the seven point scale.`,
                            isRequired: true,
                            choices: [
                                {
                                    value: "Item 1",
                                    text: "Much less willing",
                                },
                                {
                                    value: "Item 2",
                                    text: "Moderately less willing",
                                },
                                {
                                    value: "Item 3",
                                    text: "Somewhat less willing",
                                },
                                {
                                    value: "Item 4",
                                    text: "Neither more nor less willing",
                                },
                                {
                                    value: "Item 5",
                                    text: "Somewhat more willing",
                                },
                                {
                                    value: "Item 6",
                                    text: "Moderately more willing",
                                },
                                {
                                    value: "Item 7",
                                    text: "Much more willing",
                                },
                            ],
                        },
                        {
                            type: "comment",
                            name: "convo-effect-on-willingness-post",
                            title:
                                `What parts of this conversation, if any, affected your willingness to talk with someone who has different views about ${topicChoiceAsString}? What made you feel like the conversation was or was not productive?`,
                            isRequired: true,
                        },
                        {
                            type: "comment",
                            name: "new-perspective-post",
                            title:
                                `Throughout this conversation, were there any moments that opened you up to a new perspective about ${topicChoiceAsString}? If so, what occurred in these moments? If not, what made you feel like the conversation was not productive?`,
                            isRequired: true,
                        },
                        {
                            type: "comment",
                            name: "still-contributes-post",
                            title:
                                `What still contributes to your willingness or unwillingness to converse with others about ${topicChoiceAsString}? Please freely reflect in the space below.`,
                            isRequired: true,
                        },
                        {
                            type: "comment",
                            name: "feelings-about-bot",
                            title:
                                `We are still working on improving our chatbot. How did you like talking with the bot? What do you wish were different? Please provide any feedback regarding your conversation that we have not already covered.`,
                            isRequired: true,
                        },
                    ],
                };
                return experimental_group_last_questions
            },
            survey_function: initializePostSlider,
        };

        //goodbye message and brief explanation to user about our experimentation motive
        var goodbye = {
            data: {
                phase: "goodbye",
            },
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
        <p> You have completed the experiment! Thank you for your contribution to our research. </p>
        <div style='width: 700px;'>
        </div>
        <p>We are investigating how conversations can increase Americans' willingness to discuss highly disputed topics. </p>
        <p>Some existing research has examined the effects of different types of human to human conversations on this willingness, and we would like to explore these dynamics when one of the conversational partners is a chatbot. </p>
        <p> By participating in our experiment, you have helped us learn more about these effects. </p>
        <p> You were randomly assigned to either converse with a chatbot or freely reflect on your topic. If you spoke with a chatbot, you randomly experienced one of three different types of dialogue. </p>
        <div style='width: 700px;'>
        </div>
        <p> Press any key to save your data and return to Prolific!  <p>
      `,
            post_trial_gap: 1000,
        };

        /* ------------- PUSHING TIMELINE FOR EACH CONDITION ----------------- */

        counter_timeline.push(
            welcome,
            preliminary_convo_instructions,
            pre_convo_survey_trial,
            pre_bot_instructions_break,
            pre_convo_instructions,
            counter_trial,
            post_convo_break,
            republican_survey,
            democrat_survey,
            neutral_survey,
            other_survey,
            euthanasia_post_survey,
            gender_post_survey,
            healthcare_post_survey,
            bombings_post_survey,
            vaccines_post_survey,
            criminal_post_survey,
            same_sex_post_survey,
            last_questions,
            goodbye
        )

        combination_timeline.push(
            welcome,
            preliminary_convo_instructions,
            pre_convo_survey_trial,
            pre_bot_instructions_break,
            pre_convo_instructions,
            combination_trial,
            post_convo_break,
            republican_survey,
            democrat_survey,
            neutral_survey,
            other_survey,
            euthanasia_post_survey,
            gender_post_survey,
            healthcare_post_survey,
            bombings_post_survey,
            vaccines_post_survey,
            criminal_post_survey,
            same_sex_post_survey,
            last_questions,
            goodbye
        )

        question_timeline.push(
            welcome,
            preliminary_convo_instructions,
            pre_convo_survey_trial,
            pre_bot_instructions_break,
            pre_convo_instructions,
            question_trial,
            post_convo_break,
            republican_survey,
            democrat_survey,
            neutral_survey,
            other_survey,
            euthanasia_post_survey,
            gender_post_survey,
            healthcare_post_survey,
            bombings_post_survey,
            vaccines_post_survey,
            criminal_post_survey,
            same_sex_post_survey,
            last_questions,
            goodbye
        )

        viewpoint_timeline.push(
            welcome,
            preliminary_convo_instructions,
            pre_convo_survey_trial,
            pre_bot_instructions_break,
            pre_convo_instructions,
            viewpoint_trial,
            post_convo_break,
            republican_survey,
            democrat_survey,
            neutral_survey,
            other_survey,
            euthanasia_post_survey,
            gender_post_survey,
            healthcare_post_survey,
            bombings_post_survey,
            vaccines_post_survey,
            criminal_post_survey,
            same_sex_post_survey,
            last_questions,
            goodbye
        )

        control_timeline.push(
            welcome,
            preliminary_control_instructions,
            pre_convo_survey_trial,
            pre_control_break,
            control_intervention,
            post_control_break,
            republican_survey,
            democrat_survey,
            neutral_survey,
            other_survey,
            euthanasia_post_survey,
            gender_post_survey,
            healthcare_post_survey,
            bombings_post_survey,
            vaccines_post_survey,
            criminal_post_survey,
            same_sex_post_survey,
            goodbye
        )

        //SAVE EXPERIMENT DATA TO OSF via datapipe
        /*const save_data = {
            type: jsPsychPipe,
            action: "save",
            experiment_id: "P09AXWX5b5t6",
            filename: filename,
            data_string: () => jsPsych.data.get().csv()
        };*/

        createExperiment();


        //run experiment
        // jsPsych.run(timeline);

    </script>
</body>

</html>